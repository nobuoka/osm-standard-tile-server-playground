#!/usr/bin/env bash

# Required env vars:
#   POSTGRES_HOST
#   POSTGRES_ADMIN_USER
#   POSTGRES_ADMIN_PASSWORD
#   POSTGRES_MAP_USER
#   POSTGRES_MAP_PASSWORD
#   POSTGRES_MAP_DB

set -eu

PGPASSWORD=$POSTGRES_ADMIN_PASSWORD createuser --host $POSTGRES_HOST -U $POSTGRES_ADMIN_USER \
    $POSTGRES_MAP_USER

PGPASSWORD=$POSTGRES_ADMIN_PASSWORD psql --host $POSTGRES_HOST -U $POSTGRES_ADMIN_USER -d postgres \
    -c "GRANT \"$POSTGRES_MAP_USER\" TO \"$POSTGRES_ADMIN_USER\";"
PGPASSWORD=$POSTGRES_ADMIN_PASSWORD psql --host $POSTGRES_HOST -U $POSTGRES_ADMIN_USER -d postgres \
    -c "ALTER USER \"$POSTGRES_MAP_USER\" WITH PASSWORD '$POSTGRES_MAP_PASSWORD';"

PGPASSWORD=$POSTGRES_ADMIN_PASSWORD createdb --host $POSTGRES_HOST -U $POSTGRES_ADMIN_USER \
    --encoding=UTF8 --owner=$POSTGRES_MAP_USER $POSTGRES_MAP_DB

PGPASSWORD=$POSTGRES_ADMIN_PASSWORD psql --host $POSTGRES_HOST -U $POSTGRES_ADMIN_USER -d $POSTGRES_MAP_DB \
    -c "CREATE EXTENSION postgis;"
PGPASSWORD=$POSTGRES_ADMIN_PASSWORD psql --host $POSTGRES_HOST -U $POSTGRES_ADMIN_USER -d $POSTGRES_MAP_DB \
    -c "CREATE EXTENSION postgis_topology;"
PGPASSWORD=$POSTGRES_ADMIN_PASSWORD psql --host $POSTGRES_HOST -U $POSTGRES_ADMIN_USER -d $POSTGRES_MAP_DB \
    -c "CREATE EXTENSION hstore;"
PGPASSWORD=$POSTGRES_ADMIN_PASSWORD psql --host $POSTGRES_HOST -U $POSTGRES_ADMIN_USER -d $POSTGRES_MAP_DB \
    -c "ALTER TABLE geometry_columns OWNER TO $POSTGRES_MAP_USER;"
PGPASSWORD=$POSTGRES_ADMIN_PASSWORD psql --host $POSTGRES_HOST -U $POSTGRES_ADMIN_USER -d $POSTGRES_MAP_DB \
    -c "ALTER TABLE spatial_ref_sys OWNER TO $POSTGRES_MAP_USER;"
